<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6ëª¨ë‘ ì˜ ì˜›ë‚ ì˜›ì ì— ì´ì•¼ê¸° ë§Œë“¤ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --paper-bg: #fffdfa;
            --paper-texture: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            --parchment-bg: #e9e4d8;
            --parchment-texture: url('https://www.transparenttextures.com/patterns/old-paper.png');
            --ink-main: #4a3c2e;
            --ink-light: #7a6a5a;
            --accent-color: #f59e0b;
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Gowun Dodum', sans-serif;
            background-color: var(--parchment-bg);
            background-image: var(--parchment-texture);
            color: var(--ink-main);
        }
        .story-book-container, .modal-content, .info-panel, .card {
            background-color: var(--paper-bg);
            background-image: var(--paper-texture);
            border: 2px solid var(--ink-light);
            box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
        }
        .story-book {
             font-family: 'Nanum Myeongjo', serif;
        }
        .card {
            border-radius: 0.5rem;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(4px);
        }
        .btn {
            font-family: 'Gowun Dodum', sans-serif;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            box-shadow: inset 0 -3px 0 rgba(0,0,0,0.2), 0 2px 3px rgba(0,0,0,0.2);
            transition: all 0.15s ease-in-out;
            border: 1px solid rgba(0,0,0,0.2);
        }
         .btn-lg {
            padding: 0.75rem 1.5rem;
        }
        .btn:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: inset 0 -1px 0 rgba(0,0,0,0.2);
        }
        .btn-primary { background-color: #8B4513; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #A0522D; }
        .btn-primary:disabled { background-color: #a18a77; cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { background-color: #c5bba8; color: var(--ink-main); }
        .btn-secondary:hover:not(:disabled) { background-color: #d4c9b6; }
        .btn-accept { background-color: #4a7729; color: white; }
        .btn-accept:hover { background-color: #5a8e32; }
        .btn-reject { background-color: #a42424; color: white; }
        .btn-reject:hover { background-color: #c03232; }
        .player-info.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 10px 2px rgba(245, 158, 11, 0.3);
            background-color: #fef9c3;
        }
        .card-name-clickable {
            cursor: pointer;
            text-decoration: underline;
            text-underline-offset: 2px;
            color: #8B4513;
        }
        .card-name-clickable:hover {
            background-color: #fef3c7;
        }
        .story-entry-card {
            width: 4rem; /* 64px */
            height: 5.5rem; /* 88px */
            flex-shrink: 0;
        }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <!-- Start Screen / Rules -->
    <div id="start-screen" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-3xl font-bold text-stone-800 mb-4 text-center" style="font-family: 'Nanum Myeongjo', serif;">ì˜›ë‚ ì˜›ì ì— ê²Œì„ ê·œì¹™</h2>
            <div class="rules space-y-3 text-stone-700 mb-8">
                <p>ì´ ê²Œì„ì€ <strong>6ëª…ì˜ ëª¨ë‘ ì›</strong>ì´ í•œ í™”ë©´ì„ ë³´ê³  í•¨ê»˜ í”Œë ˆì´í•˜ëŠ” ê²Œì„ì…ë‹ˆë‹¤.</p>
                <ul class="space-y-2">
                    <li><strong>ëª©í‘œ:</strong> 'ì˜¤ëŠ˜ì˜ ê²°ë§' ì¹´ë“œë¡œ ì´ì•¼ê¸°ë¥¼ ì™„ì„±í•˜ê³ , ë‹¤ë¥¸ ëª¨ë‘ ì›ë“¤ì˜ 'ìˆ˜ë½'ì„ ë°›ì•„ ìŠ¹ë¦¬í•˜ì„¸ìš”.</li>
                    <li><strong>ê²Œì„ ì§„í–‰:</strong>
                        <ol class="list-decimal pl-5 mt-1 space-y-1">
                            <li>ìê¸° ì°¨ë¡€ì— ì¹´ë“œë¥¼ ë‚´ê³  ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ë©´, ë‹¤ë¥¸ ëª¨ë‘ ì›ë“¤ì´ 'ìˆ˜ë½/ê¸°ê°' íˆ¬í‘œë¥¼ í•©ë‹ˆë‹¤.</li>
                            <li><strong>ê¸°ê°</strong>ë˜ë©´ ì¹´ë“œëŠ” ì†ìœ¼ë¡œ ëŒì•„ì˜¤ê³  ì¦‰ì‹œ ì°¨ë¡€ê°€ ë„˜ì–´ê°‘ë‹ˆë‹¤.</li>
                            <li><strong>ìˆ˜ë½</strong>ë˜ë©´ ì´ì•¼ê¸°ê°€ ì´ì–´ì§€ê³ , ì¹´ë“œë¥¼ ë” ë‚´ê±°ë‚˜ 'ì°¨ë¡€ ëë‚´ê¸°'ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                            <li>'ì°¨ë¡€ ëë‚´ê¸°'ë¥¼ ëˆ„ë¥´ë©´ ì¹´ë“œ ë”ë¯¸ì—ì„œ <strong>ìƒˆ ì¹´ë“œ í•œ ì¥</strong>ì„ ë°›ê³  í„´ì´ ë„˜ì–´ê°‘ë‹ˆë‹¤.</li>
                            <li>ìê¸° ì°¨ë¡€ë¼ë©´ ì–¸ì œë“  'ê²°ë§ ì¹´ë“œ ë‚´ê¸°'ë¥¼ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì´ ë˜í•œ íˆ¬í‘œë¥¼ ê±°ì¹©ë‹ˆë‹¤)</li>
                        </ol>
                    </li>
                </ul>
                <p class="text-center font-bold text-amber-700 mt-6">ëª¨ë‘ì˜ ìƒìƒë ¥ì„ í•©ì³ ë©‹ì§„ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”!</p>
            </div>
            <button id="start-game-button" class="w-full btn btn-lg btn-primary text-lg">ì´ì•¼ê¸° ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <!-- Game Container -->
    <div id="game-container" class="max-w-screen-2xl mx-auto hidden h-full">
        <div class="grid grid-cols-12 gap-6 h-full">
            <!-- Left Side: Story -->
            <div class="col-span-8 flex flex-col h-full">
                <header class="text-center mb-4 flex-shrink-0">
                    <h1 class="text-5xl font-bold text-stone-800" style="font-family: 'Nanum Myeongjo', serif;">ì˜›ë‚  ì˜›ì ì—</h1>
                </header>
                <main class="story-book-container p-6 lg:p-8 rounded-lg flex-grow flex flex-col">
                    <h2 class="text-3xl font-bold border-b-2 border-stone-300 pb-3 mb-4 text-stone-800">ì´ì•¼ê¸° ì±…</h2>
                    <div id="story-area" class="flex-grow overflow-y-auto pr-4 space-y-6 text-xl lg:text-2xl leading-relaxed"></div>
                    <div id="shared-ending-card-container" class="mt-4 pt-4 border-t-2 border-dashed border-stone-300 text-center">
                        <h3 class="text-lg font-bold text-amber-800 mb-2">ì˜¤ëŠ˜ì˜ ê²°ë§</h3>
                        <div id="ending-card" class="text-amber-900 p-2 bg-amber-100/50 rounded text-xl font-semibold"></div>
                    </div>
                </main>
            </div>

            <!-- Right Side: Game Info -->
            <aside class="col-span-4 flex flex-col h-full">
                <div id="game-info-panel" class="info-panel p-6 rounded-lg w-full flex-grow flex flex-col">
                    <h3 class="text-2xl font-bold text-stone-800 mb-4 border-b border-stone-300 pb-2 text-center" style="font-family: 'Nanum Myeongjo', serif;">ê²Œì„ í˜„í™©</h3>
                    <div class="space-y-2 text-lg text-center mb-4">
                        <p>ë‚¨ì€ ì¹´ë“œ ë”ë¯¸: <span id="deck-count" class="font-bold">0</span>ì¥</p>
                        <p>ì‚¬ìš©í•œ ì¹´ë“œ: <span id="played-card-count" class="font-bold">0</span>ì¥</p>
                    </div>
                    <div id="all-player-info-container" class="flex-grow overflow-y-auto space-y-3">
                        <!-- Player info will be injected here -->
                    </div>
                </div>
            </aside>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="story-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4">ì´ì•¼ê¸° ë§Œë“¤ê¸°</h3>
            <p class="mb-2">ì„ íƒí•œ ì¹´ë“œë¥¼ ì‚¬ìš©í•´ ë‹¤ìŒ ë¬¸ì¥ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”:</p>
            <div id="selected-card-info" class="mb-4 p-3 bg-gray-100 rounded-md font-bold text-center"></div>
            <textarea id="story-input" class="w-full h-24 p-2 border rounded-md focus:ring-2 focus:ring-amber-400 focus:outline-none"></textarea>
            <div class="flex justify-end mt-4 space-x-2">
                <button id="cancel-story-button" class="btn btn-secondary">ì·¨ì†Œ</button>
                <button id="submit-story-button" class="btn btn-primary">ì œì¶œí•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="validation-modal" class="modal-backdrop hidden">
        <div class="modal-content text-center">
            <h3 id="validation-title" class="text-3xl font-bold mb-4 text-amber-700" style="font-family: 'Nanum Myeongjo', serif;"></h3>
            <p id="proposer-announcement" class="mb-4 text-lg"></p>
            <div id="validation-story-preview" class="mb-6 p-4 bg-stone-50 rounded text-left h-64 overflow-y-auto" style="font-family: 'Nanum Myeongjo', serif;"></div>
            <p class="mb-6 font-semibold">ì´ ì´ì•¼ê¸°ì— ë™ì˜í•˜ì‹œë‚˜ìš”?</p>
            <div class="flex justify-center gap-4">
                <button id="reject-button" class="btn btn-lg btn-reject">ê¸°ê°</button>
                <button id="accept-button" class="btn btn-lg btn-accept">ìˆ˜ë½</button>
            </div>
        </div>
    </div>

    <div id="win-modal" class="modal-backdrop hidden">
        <div class="modal-content text-center">
            <h3 class="text-4xl font-bold mb-4 text-amber-600" style="font-family: 'Nanum Myeongjo', serif;">ğŸ‰ ì´ì•¼ê¸° ì™„ì„±! ğŸ‰</h3>
            <p id="winner-announcement" class="mb-6 text-xl"></p>
            <div id="final-story-preview" class="mb-6 p-4 bg-stone-50 rounded text-left h-64 overflow-y-auto" style="font-family: 'Nanum Myeongjo', serif;"></div>
            <button id="play-again-button" class="w-full btn btn-lg btn-primary">ìƒˆë¡œìš´ ì´ì•¼ê¸° ë§Œë“¤ê¸°</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const startScreen = document.getElementById('start-screen'),
            startGameBtn = document.getElementById('start-game-button'),
            gameContainer = document.getElementById('game-container'),
            storyArea = document.getElementById('story-area'),
            deckCountEl = document.getElementById('deck-count'),
            playedCardCountEl = document.getElementById('played-card-count'),
            allPlayerInfoContainer = document.getElementById('all-player-info-container'),
            endingCardEl = document.getElementById('ending-card'),
            storyModal = document.getElementById('story-modal'),
            selectedCardInfo = document.getElementById('selected-card-info'),
            storyInput = document.getElementById('story-input'),
            cancelStoryButton = document.getElementById('cancel-story-button'),
            submitStoryButton = document.getElementById('submit-story-button'),
            validationModal = document.getElementById('validation-modal'),
            validationTitle = document.getElementById('validation-title'),
            proposerAnnouncement = document.getElementById('proposer-announcement'),
            validationStoryPreview = document.getElementById('validation-story-preview'),
            rejectButton = document.getElementById('reject-button'),
            acceptButton = document.getElementById('accept-button'),
            winModal = document.getElementById('win-modal'),
            winnerAnnouncement = document.getElementById('winner-announcement'),
            finalStoryPreview = document.getElementById('final-story-preview'),
            playAgainButton = document.getElementById('play-again-button');

        // Card Data
        const STORY_CARDS = [ { name: "ì™•ì", type: "ì¸ë¬¼", icon: "ğŸ¤´" }, { name: "ê³µì£¼", type: "ì¸ë¬¼", icon: "ğŸ‘¸" }, { name: "ë§ˆë…€", type: "ì¸ë¬¼", icon: "ğŸ§™â€â™€ï¸" }, { name: "ìš©", type: "ì¸ë¬¼", icon: "ğŸ‰" }, { name: "ê¸°ì‚¬", type: "ì¸ë¬¼", icon: "ğŸ›¡ï¸" }, { name: "ìš”ì •", type: "ì¸ë¬¼", icon: "ğŸ§šâ€â™€ï¸" }, { name: "ì™•", type: "ì¸ë¬¼", icon: "ğŸ‘‘" }, { name: "ì—¬ì™•", type: "ì¸ë¬¼", icon: "ğŸ‘¸" }, { name: "ë™ë¬¼ ì¡°ë ¥ì", type: "ì¸ë¬¼", icon: "ğŸ•" }, { name: "ê±°ì¸", type: "ì¸ë¬¼", icon: "ğŸ‘¹" }, { name: "ë‚œìŸì´", type: "ì¸ë¬¼", icon: "ğŸ‘¨â€ğŸŒ¾" }, { name: "ë§ˆë²•ì‚¬", type: "ì¸ë¬¼", icon: "ğŸ§™â€â™‚ï¸" }, { name: "ì‚¬ëƒ¥ê¾¼", type: "ì¸ë¬¼", icon: "ğŸ¹" }, { name: "í˜„ì", type: "ì¸ë¬¼", icon: "ğŸ‘´" }, { name: "ê´´ë¬¼", type: "ì¸ë¬¼", icon: "ğŸ‘¾" }, { name: "ìœ ë ¹", type: "ì¸ë¬¼", icon: "ğŸ‘»" }, { name: "í•´ì ", type: "ì¸ë¬¼", icon: "ğŸ´â€â˜ ï¸" }, { name: "ìŒìœ ì‹œì¸", type: "ì¸ë¬¼", icon: "ğŸ¶" }, { name: "ë„ë‘‘", type: "ì¸ë¬¼", icon: "ğŸƒ" }, { name: "ê³µì£¼", type: "ì¸ë¬¼", icon: "ğŸ‘¸" }, { name: "ìˆ²", type: "ì¥ì†Œ", icon: "ğŸŒ²" }, { name: "ì„±", type: "ì¥ì†Œ", icon: "ğŸ°" }, { name: "ë™êµ´", type: "ì¥ì†Œ", icon: "ğŸ¦‡" }, { name: "ë§ˆì„", type: "ì¥ì†Œ", icon: "ğŸ˜ï¸" }, { name: "íƒ‘", type: "ì¥ì†Œ", icon: "ğŸ—¼" }, { name: "ê°•", type: "ì¥ì†Œ", icon: "ğŸï¸" }, { name: "ì‹œì¥", type: "ì¥ì†Œ", icon: "ğŸ›’" }, { name: "ë‹¤ë¦¬", type: "ì¥ì†Œ", icon: "ğŸŒ‰" }, { name: "ë°”ë‹¤", type: "ì¥ì†Œ", icon: "ğŸŒŠ" }, { name: "ì‚¬ë§‰", type: "ì¥ì†Œ", icon: "ğŸœï¸" }, { name: "íí—ˆ", type: "ì¥ì†Œ", icon: "ğŸšï¸" }, { name: "ë¯¸ê¶", type: "ì¥ì†Œ", icon: "ğŸŒ€" }, { name: "í­í¬", type: "ì¥ì†Œ", icon: "ğŸŒŠ" }, { name: "ì‚°", type: "ì¥ì†Œ", icon: "â›°ï¸" }, { name: "ì„¬", type: "ì¥ì†Œ", icon: "ğŸï¸" }, { name: "ë§ˆë²• ì§€íŒ¡ì´", type: "ì‚¬ë¬¼", icon: "ğŸª„" }, { name: "ê²€", type: "ì‚¬ë¬¼", icon: "âš”ï¸" }, { name: "ì§€ë„", type: "ì‚¬ë¬¼", icon: "ğŸ—ºï¸" }, { name: "ë³´ë¬¼", type: "ì‚¬ë¬¼", icon: "ğŸ’" }, { name: "ì—´ì‡ ", type: "ì‚¬ë¬¼", icon: "ğŸ”‘" }, { name: "ë¬¼ì•½", type: "ì‚¬ë¬¼", icon: "ğŸ§ª" }, { name: "ë°˜ì§€", type: "ì‚¬ë¬¼", icon: "ğŸ’" }, { name: "ê±°ìš¸", type: "ì‚¬ë¬¼", icon: "ğŸª" }, { name: "ë§í† ", type: "ì‚¬ë¬¼", icon: "ğŸ§¥" }, { name: "ì™•ê´€", type: "ì‚¬ë¬¼", icon: "ğŸ‘‘" }, { name: "ë…ì•½", type: "ì‚¬ë¬¼", icon: "â˜ ï¸" }, { name: "ì£¼ë¬¸ì„œ", type: "ì‚¬ë¬¼", icon: "ğŸ“œ" }, { name: "ë‚˜ì¹¨ë°˜", type: "ì‚¬ë¬¼", icon: "ğŸ§­" }, { name: "ê°€ë©´", type: "ì‚¬ë¬¼", icon: "ğŸ­" }, { name: "ë³´ì„", type: "ì‚¬ë¬¼", icon: "ğŸ’" }, { name: "ë°°", type: "ì‚¬ë¬¼", icon: "â›µ" }, { name: "ìƒì", type: "ì‚¬ë¬¼", icon: "ğŸ“¦" }, { name: "ë¨í”„", type: "ì‚¬ë¬¼", icon: "ğŸ’¡" }, { name: "ì±…", type: "ì‚¬ë¬¼", icon: "ğŸ“–" }, { name: "í™œ", type: "ì‚¬ë¬¼", icon: "ğŸ¹" }, { name: "í–‰ë³µí•˜ê²Œ", type: "ìƒíƒœ", icon: "ğŸ˜Š" }, { name: "ìŠ¬í”„ê²Œ", type: "ìƒíƒœ", icon: "ğŸ˜¢" }, { name: "ìš©ê°í•˜ê²Œ", type: "ìƒíƒœ", icon: "ğŸ’ª" }, { name: "ì‹ ë¹„ë¡­ê²Œ", type: "ìƒíƒœ", icon: "âœ¨" }, { name: "ë¹„ë°€ìŠ¤ëŸ½ê²Œ", type: "ìƒíƒœ", icon: "ğŸ¤«" }, { name: "ì˜ì›íˆ", type: "ìƒíƒœ", icon: "â™¾ï¸" }, { name: "ìš´ëª…ì²˜ëŸ¼", type: "ìƒíƒœ", icon: "ğŸ’«" }, { name: "ì €ì£¼ë°›ì€", type: "ìƒíƒœ", icon: "ğŸ’€" }, { name: "ì¶•ë³µë°›ì€", type: "ìƒíƒœ", icon: "ğŸŒŸ" }, { name: "ìˆ¨ê²¨ì§„", type: "ìƒíƒœ", icon: "ğŸšª" }, { name: "ë°°ê³ í”ˆ", type: "ìƒíƒœ", icon: "ğŸ˜‹" }, { name: "ì•„ë¦„ë‹¤ìš´", type: "ìƒíƒœ", icon: "ğŸ˜" }, { name: "ë¬´ì„œìš´", type: "ìƒíƒœ", icon: "ğŸ˜±" }, { name: "ë¶€ìœ í•œ", type: "ìƒíƒœ", icon: "ğŸ’°" }, { name: "ê°€ë‚œí•œ", type: "ìƒíƒœ", icon: "ğŸ˜Ÿ" }, { name: "ê°‘ìê¸°", type: "ì‚¬ê±´", icon: "âš¡ï¸" }, { name: "ì˜¤ë˜ ì „", type: "ì‚¬ê±´", icon: "ğŸ“œ" }, { name: "ìœ„í—˜ì— ë¹ ì¡Œë‹¤", type: "ì‚¬ê±´", icon: "ğŸ”¥" }, { name: "ì—¬í–‰ì„ ë– ë‚¬ë‹¤", type: "ì‚¬ê±´", icon: "ğŸš¶â€â™‚ï¸" }, { name: "ì ì´ ë“¤ì—ˆë‹¤", type: "ì‚¬ê±´", icon: "ğŸ˜´" }, { name: "í•¨ì •ì— ë¹ ì¡Œë‹¤", type: "ì‚¬ê±´", icon: "ğŸ•³ï¸" }, { name: "ë³€ì‹ í–ˆë‹¤", type: "ì‚¬ê±´", icon: "ğŸ¦‹" }, { name: "ì‹¸ì› ë‹¤", type: "ì‚¬ê±´", icon: "ğŸ’¥" }, { name: "ë„ë§ì³¤ë‹¤", type: "ì‚¬ê±´", icon: "ğŸ’¨" }, { name: "ì¶•ì œê°€ ì—´ë ¸ë‹¤", type: "ì‚¬ê±´", icon: "ğŸ‰" }, { name: "ê²°í˜¼í–ˆë‹¤", type: "ì‚¬ê±´", icon: "ğŸ’’" }, { name: "ê¸¸ì„ ìƒì—ˆë‹¤", type: "ì‚¬ê±´", icon: "â“" }, { name: "ë§Œë‚¬ë‹¤", type: "ì‚¬ê±´", icon: "ğŸ¤" }, { name: "í—¤ì–´ì¡Œë‹¤", type: "ì‚¬ê±´", icon: "ğŸ’”" }, { name: "ë°œê²¬í–ˆë‹¤", type: "ì‚¬ê±´", icon: "ğŸ’¡" } ];
        const ENDING_CARDS = [ "ê·¸ë¦¬ê³  ëª¨ë‘ëŠ” í–‰ë³µí•˜ê²Œ ì‚´ì•˜ë‹µë‹ˆë‹¤.", "ê·¸ë¦¬í•˜ì—¬ ì™•êµ­ì—ëŠ” í‰í™”ê°€ ì°¾ì•„ì™”ìŠµë‹ˆë‹¤.", "í•˜ì§€ë§Œ ë†€ëê²Œë„, ê·¸ ëª¨ë“  ê²ƒì€ ê¿ˆì´ì—ˆìŠµë‹ˆë‹¤.", "ê·¸ ìš©ê°í•œ í–‰ë™ì€ ì „ì„¤ë¡œ ë‚¨ì•„ ì˜ì›íˆ ê¸°ì–µë˜ì—ˆìŠµë‹ˆë‹¤.", "ê·¸ë¦¬ê³  ë§ˆë²•ì€ í’€ë ¸ì§€ë§Œ, ë” ì†Œì¤‘í•œ ê²ƒì„ ì–»ì—ˆìŠµë‹ˆë‹¤.", "ê·¸ í›„ë¡œ ì•„ë¬´ë„ ê·¸ë“¤ì˜ ì†Œì‹ì„ ë“¤ì„ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.", "ë§ˆì¹¨ë‚´ ì˜¤ë«ë™ì•ˆ ì°¾ì•„ í—¤ë§¤ë˜ ê²ƒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.", "ê·¸ëŸ¬ë‚˜ ê·¸ë“¤ì˜ ëª¨í—˜ì€ ì´ì œ ë§‰ ì‹œì‘ì¼ ë¿ì´ì—ˆìŠµë‹ˆë‹¤.", "ëª¨ë“  ë¹„ë°€ì´ ë°í˜€ì§€ê³  ìƒˆë¡œìš´ ì‹œëŒ€ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤.", "ê·¸ë¦¬í•˜ì—¬ ì˜ˆì–¸ì€ ë§ˆì¹¨ë‚´ ì‹¤í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.", "ê²°êµ­, ê·¸ë“¤ì€ ì›ë˜ ìˆë˜ ê³³ìœ¼ë¡œ ëŒì•„ê°”ìŠµë‹ˆë‹¤." ];

        let gameState = {};

        function initGameState() {
            const storyDeck = shuffle([...STORY_CARDS]);
            const endingDeck = shuffle([...ENDING_CARDS]);
            
            const players = [];
            for (let i = 1; i <= 6; i++) {
                players.push({
                    name: `${i}ëª¨ë‘ `,
                    hand: storyDeck.splice(0, 5)
                });
            }

            gameState = {
                players: players,
                storyDeck: storyDeck,
                sharedEndingCard: endingDeck.pop(),
                playedCards: [],
                story: [{ type: 'start', text: 'ì˜›ë‚  ì˜›ì ì—...' }],
                currentPlayerIndex: 0,
                activeCard: null,
                activeText: '',
                status: 'playing',
                validationType: null,
            };
        }

        function startGame() {
            startScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            initGameState();
            render();
        }

        function renderStory(storyArray, container) {
            container.innerHTML = storyArray.map(entry => {
                if (entry.type === 'start') {
                    return `<p class="text-center font-bold">${entry.text}</p>`;
                }
                if (entry.type === 'entry') {
                    return `
                        <div class="flex items-start gap-4">
                            ${createCardElement(entry.card, true, -1, 'story-entry-card').outerHTML}
                            <div>
                                <p class="font-bold text-base text-stone-500">${entry.player}ë‹˜ì˜ ì´ì•¼ê¸°</p>
                                <p>${entry.text}</p>
                            </div>
                        </div>
                    `;
                }
                 if (entry.type === 'ending') {
                    return `
                        <div class="p-4 text-center bg-amber-100/50 rounded-lg border-2 border-amber-300">
                            <p class="font-bold text-base text-stone-500">${entry.player}ë‹˜ì´ ì´ì•¼ê¸°ë¥¼ ë§ˆë¬´ë¦¬í–ˆìŠµë‹ˆë‹¤.</p>
                            <p class="text-2xl font-bold text-amber-700">${entry.text}</p>
                        </div>
                    `;
                }
                return '';
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function render() {
            renderStory(gameState.story, storyArea);

            deckCountEl.textContent = gameState.storyDeck.length;
            playedCardCountEl.textContent = gameState.playedCards.length;
            endingCardEl.textContent = gameState.sharedEndingCard;

            allPlayerInfoContainer.innerHTML = '';
            gameState.players.forEach((player, index) => {
                const isCurrentPlayer = index === gameState.currentPlayerIndex;
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-info p-3 my-2 rounded-lg border-2 border-stone-300 transition-all ${isCurrentPlayer ? 'active' : ''}`;

                let cardsHtml = player.hand.map((card, cardIndex) => {
                    if (isCurrentPlayer) {
                        return `<span class="card-name-clickable p-1 rounded" data-card-index="${cardIndex}">${card.name}</span>`;
                    } else {
                        return `<span class="card-name-disabled p-1">${card.name}</span>`;
                    }
                }).join(', ');

                let buttonsHtml = '';
                if (isCurrentPlayer) {
                    buttonsHtml = `
                        <div class="flex gap-2 mt-3">
                            <button class="play-ending-button w-1/2 btn btn-primary text-xs">ê²°ë§ ë‚´ê¸°</button>
                            <button class="end-turn-button w-1/2 btn btn-secondary text-xs">ì°¨ë¡€ ëë‚´ê¸°</button>
                        </div>
                    `;
                }

                playerDiv.innerHTML = `
                    <h4 class="font-bold text-lg text-center ${isCurrentPlayer ? 'text-amber-700' : ''}">${player.name} (${player.hand.length}ì¥) ${isCurrentPlayer ? 'â†’' : ''}</h4>
                    <div class="text-base text-stone-600 mt-2 text-center leading-relaxed">${cardsHtml || 'ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.'}</div>
                    ${buttonsHtml}
                `;
                allPlayerInfoContainer.appendChild(playerDiv);
            });

            if (gameState.status === 'playing') {
                document.querySelectorAll('.card-name-clickable').forEach(el => {
                    el.addEventListener('click', onCardNameClick);
                });
                const endTurnBtn = document.querySelector('.end-turn-button');
                if (endTurnBtn) endTurnBtn.addEventListener('click', endTurn);
                const playEndingBtn = document.querySelector('.play-ending-button');
                if (playEndingBtn) playEndingBtn.addEventListener('click', onPlayEndingCardClick);
            }
        }

        function onCardNameClick(event) {
            const cardIndex = event.currentTarget.dataset.cardIndex;
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            gameState.activeCard = { ...currentPlayer.hand[cardIndex], index: cardIndex };
            
            selectedCardInfo.innerHTML = createCardElement(gameState.activeCard, false, -1, 'mx-auto').outerHTML;
            storyInput.value = '';
            storyInput.placeholder = `ì˜ˆ: ${gameState.activeCard.name}ì´/ê°€ ë“±ì¥í•˜ì—¬...`;
            storyModal.classList.remove('hidden');
            storyInput.focus();
        }

        function submitStory() {
            const text = storyInput.value.trim();
            if (text === '' || !gameState.activeCard) return;

            gameState.activeText = text;
            storyModal.classList.add('hidden');
            
            gameState.status = 'validating';
            gameState.validationType = 'story';

            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            validationTitle.textContent = "ì´ì•¼ê¸° ì‹¬ì‚¬";
            proposerAnnouncement.textContent = `${currentPlayer.name}ë‹˜ì´ ë‹¤ìŒ ì´ì•¼ê¸° ì¹´ë“œë¥¼ ë‚´ë ¤ í•©ë‹ˆë‹¤:`;
            
            const tempStory = [...gameState.story, { type: 'entry', player: currentPlayer.name, text: gameState.activeText, card: gameState.activeCard }];
            renderStory(tempStory, validationStoryPreview);
            
            validationModal.classList.remove('hidden');
        }

        function endTurn() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            if (gameState.storyDeck.length > 0) {
                currentPlayer.hand.push(gameState.storyDeck.pop());
            }
            gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            render();
        }

        function onPlayEndingCardClick() {
            gameState.status = 'validating';
            gameState.validationType = 'ending';

            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            validationTitle.textContent = "ê²°ë§ ì‹¬ì‚¬";
            proposerAnnouncement.textContent = `${currentPlayer.name}ë‹˜ì´ ë‹¤ìŒ ê²°ë§ë¡œ ì´ì•¼ê¸°ë¥¼ ëë‚´ë ¤ê³  í•©ë‹ˆë‹¤:`;
            
            const finalStory = [...gameState.story, { type: 'ending', player: currentPlayer.name, text: gameState.sharedEndingCard }];
            renderStory(finalStory, validationStoryPreview);
            
            validationModal.classList.remove('hidden');
        }

        function handleAccept() {
            validationModal.classList.add('hidden');
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];

            if (gameState.validationType === 'story') {
                gameState.story.push({ type: 'entry', player: currentPlayer.name, text: gameState.activeText, card: gameState.activeCard });
                const playedCard = currentPlayer.hand.splice(gameState.activeCard.index, 1)[0];
                gameState.playedCards.push(playedCard);
                
                gameState.activeCard = null;
                gameState.activeText = '';
                gameState.status = 'playing';
                render();
            } else if (gameState.validationType === 'ending') {
                gameState.story.push({ type: 'ending', player: currentPlayer.name, text: gameState.sharedEndingCard });
                gameState.status = 'finished';
                winnerAnnouncement.textContent = `${currentPlayer.name}ë‹˜ì´ ë©‹ì§„ ì´ì•¼ê¸°ë¥¼ ì™„ì„±í–ˆìŠµë‹ˆë‹¤!`;
                renderStory(gameState.story, finalStoryPreview);
                winModal.classList.remove('hidden');
            }
        }

        function handleReject() {
            validationModal.classList.add('hidden');
            
            if (gameState.validationType === 'story') {
                alert('ì´ì•¼ê¸°ê°€ ê¸°ê°ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´ë“œëŠ” ì†ìœ¼ë¡œ ëŒì•„ê°€ê³  ì°¨ë¡€ê°€ ë„˜ì–´ê°‘ë‹ˆë‹¤.');
                gameState.activeCard = null;
                gameState.activeText = '';
                endTurn();
            } else if (gameState.validationType === 'ending') {
                alert('ê²°ë§ì´ ê¸°ê°ë˜ì—ˆìŠµë‹ˆë‹¤. ì°¨ë¡€ê°€ ë„˜ì–´ê°‘ë‹ˆë‹¤.');
                gameState.status = 'playing';
                endTurn();
            }
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function createCardElement(card, isDisabled, cardIndex, extraClasses = '') {
            const el = document.createElement('div');
            el.className = `card w-24 h-36 p-2 flex flex-col justify-between items-center ${isDisabled ? 'disabled' : ''} ${extraClasses}`;
            el.dataset.cardIndex = cardIndex;
            el.innerHTML = `
                <div class="text-xs font-bold px-2 py-0.5 bg-stone-200 text-stone-600 rounded-full">${card.type}</div>
                <div class="text-5xl my-1 flex-grow flex items-center">${card.icon}</div>
                <div class="text-center text-sm font-semibold text-stone-800">${card.name}</div>
            `;
            return el;
        }

        // Event Listeners
        startGameBtn.addEventListener('click', startGame);
        submitStoryButton.addEventListener('click', submitStory);
        storyInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitStory();
            }
        });
        cancelStoryButton.addEventListener('click', () => {
            storyModal.classList.add('hidden');
            gameState.activeCard = null;
        });
        acceptButton.addEventListener('click', handleAccept);
        rejectButton.addEventListener('click', handleReject);
        playAgainButton.addEventListener('click', () => {
            winModal.classList.add('hidden');
            gameContainer.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
    </script>
</body>
</html>
