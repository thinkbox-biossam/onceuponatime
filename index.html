<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6모둠의 옛날옛적에 이야기 만들기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --paper-bg: #fffdfa;
            --paper-texture: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            --parchment-bg: #e9e4d8;
            --parchment-texture: url('https://www.transparenttextures.com/patterns/old-paper.png');
            --ink-main: #4a3c2e;
            --ink-light: #7a6a5a;
            --accent-color: #f59e0b;
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Gowun Dodum', sans-serif;
            background-color: var(--parchment-bg);
            background-image: var(--parchment-texture);
            color: var(--ink-main);
        }
        .story-book-container, .modal-content, .info-panel, .card {
            background-color: var(--paper-bg);
            background-image: var(--paper-texture);
            border: 2px solid var(--ink-light);
            box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
        }
        .story-book {
             font-family: 'Nanum Myeongjo', serif;
        }
        .card {
            border-radius: 0.5rem;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(4px);
        }
        .btn {
            font-family: 'Gowun Dodum', sans-serif;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            box-shadow: inset 0 -3px 0 rgba(0,0,0,0.2), 0 2px 3px rgba(0,0,0,0.2);
            transition: all 0.15s ease-in-out;
            border: 1px solid rgba(0,0,0,0.2);
        }
         .btn-lg {
            padding: 0.75rem 1.5rem;
        }
        .btn:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: inset 0 -1px 0 rgba(0,0,0,0.2);
        }
        .btn-primary { background-color: #8B4513; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #A0522D; }
        .btn-primary:disabled { background-color: #a18a77; cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { background-color: #c5bba8; color: var(--ink-main); }
        .btn-secondary:hover:not(:disabled) { background-color: #d4c9b6; }
        .btn-accept { background-color: #4a7729; color: white; }
        .btn-accept:hover { background-color: #5a8e32; }
        .btn-reject { background-color: #a42424; color: white; }
        .btn-reject:hover { background-color: #c03232; }
        .player-info.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 10px 2px rgba(245, 158, 11, 0.3);
            background-color: #fef9c3;
        }
        .card-name-clickable {
            cursor: pointer;
            text-decoration: underline;
            text-underline-offset: 2px;
            color: #8B4513;
        }
        .card-name-clickable:hover {
            background-color: #fef3c7;
        }
        .story-entry-card {
            width: 4rem; /* 64px */
            height: 5.5rem; /* 88px */
            flex-shrink: 0;
        }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <!-- Start Screen / Rules -->
    <div id="start-screen" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-3xl font-bold text-stone-800 mb-4 text-center" style="font-family: 'Nanum Myeongjo', serif;">옛날옛적에 게임 규칙</h2>
            <div class="rules space-y-3 text-stone-700 mb-8">
                <p>이 게임은 <strong>6명의 모둠원</strong>이 한 화면을 보고 함께 플레이하는 게임입니다.</p>
                <ul class="space-y-2">
                    <li><strong>목표:</strong> '오늘의 결말' 카드로 이야기를 완성하고, 다른 모둠원들의 '수락'을 받아 승리하세요.</li>
                    <li><strong>게임 진행:</strong>
                        <ol class="list-decimal pl-5 mt-1 space-y-1">
                            <li>자기 차례에 카드를 내고 이야기를 만들면, 다른 모둠원들이 '수락/기각' 투표를 합니다.</li>
                            <li><strong>기각</strong>되면 카드는 손으로 돌아오고 즉시 차례가 넘어갑니다.</li>
                            <li><strong>수락</strong>되면 이야기가 이어지고, 카드를 더 내거나 '차례 끝내기'를 선택할 수 있습니다.</li>
                            <li>'차례 끝내기'를 누르면 카드 더미에서 <strong>새 카드 한 장</strong>을 받고 턴이 넘어갑니다.</li>
                            <li>자기 차례라면 언제든 '결말 카드 내기'를 시도할 수 있습니다. (이 또한 투표를 거칩니다)</li>
                        </ol>
                    </li>
                </ul>
                <p class="text-center font-bold text-amber-700 mt-6">모두의 상상력을 합쳐 멋진 이야기를 만들어 보세요!</p>
            </div>
            <button id="start-game-button" class="w-full btn btn-lg btn-primary text-lg">이야기 시작하기</button>
        </div>
    </div>

    <!-- Game Container -->
    <div id="game-container" class="max-w-screen-2xl mx-auto hidden h-full">
        <div class="grid grid-cols-12 gap-6 h-full">
            <!-- Left Side: Story -->
            <div class="col-span-8 flex flex-col h-full">
                <header class="text-center mb-4 flex-shrink-0">
                    <h1 class="text-5xl font-bold text-stone-800" style="font-family: 'Nanum Myeongjo', serif;">옛날 옛적에</h1>
                </header>
                <main class="story-book-container p-6 lg:p-8 rounded-lg flex-grow flex flex-col">
                    <h2 class="text-3xl font-bold border-b-2 border-stone-300 pb-3 mb-4 text-stone-800">이야기 책</h2>
                    <div id="story-area" class="flex-grow overflow-y-auto pr-4 space-y-6 text-xl lg:text-2xl leading-relaxed"></div>
                    <div id="shared-ending-card-container" class="mt-4 pt-4 border-t-2 border-dashed border-stone-300 text-center">
                        <h3 class="text-lg font-bold text-amber-800 mb-2">오늘의 결말</h3>
                        <div id="ending-card" class="text-amber-900 p-2 bg-amber-100/50 rounded text-xl font-semibold"></div>
                    </div>
                </main>
            </div>

            <!-- Right Side: Game Info -->
            <aside class="col-span-4 flex flex-col h-full">
                <div id="game-info-panel" class="info-panel p-6 rounded-lg w-full flex-grow flex flex-col">
                    <h3 class="text-2xl font-bold text-stone-800 mb-4 border-b border-stone-300 pb-2 text-center" style="font-family: 'Nanum Myeongjo', serif;">게임 현황</h3>
                    <div class="space-y-2 text-lg text-center mb-4">
                        <p>남은 카드 더미: <span id="deck-count" class="font-bold">0</span>장</p>
                        <p>사용한 카드: <span id="played-card-count" class="font-bold">0</span>장</p>
                    </div>
                    <div id="all-player-info-container" class="flex-grow overflow-y-auto space-y-3">
                        <!-- Player info will be injected here -->
                    </div>
                </div>
            </aside>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="story-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4">이야기 만들기</h3>
            <p class="mb-2">선택한 카드를 사용해 다음 문장을 만들어 보세요:</p>
            <div id="selected-card-info" class="mb-4 p-3 bg-gray-100 rounded-md font-bold text-center"></div>
            <textarea id="story-input" class="w-full h-24 p-2 border rounded-md focus:ring-2 focus:ring-amber-400 focus:outline-none"></textarea>
            <div class="flex justify-end mt-4 space-x-2">
                <button id="cancel-story-button" class="btn btn-secondary">취소</button>
                <button id="submit-story-button" class="btn btn-primary">제출하기</button>
            </div>
        </div>
    </div>

    <div id="validation-modal" class="modal-backdrop hidden">
        <div class="modal-content text-center">
            <h3 id="validation-title" class="text-3xl font-bold mb-4 text-amber-700" style="font-family: 'Nanum Myeongjo', serif;"></h3>
            <p id="proposer-announcement" class="mb-4 text-lg"></p>
            <div id="validation-story-preview" class="mb-6 p-4 bg-stone-50 rounded text-left h-64 overflow-y-auto" style="font-family: 'Nanum Myeongjo', serif;"></div>
            <p class="mb-6 font-semibold">이 이야기에 동의하시나요?</p>
            <div class="flex justify-center gap-4">
                <button id="reject-button" class="btn btn-lg btn-reject">기각</button>
                <button id="accept-button" class="btn btn-lg btn-accept">수락</button>
            </div>
        </div>
    </div>

    <div id="win-modal" class="modal-backdrop hidden">
        <div class="modal-content text-center">
            <h3 class="text-4xl font-bold mb-4 text-amber-600" style="font-family: 'Nanum Myeongjo', serif;">🎉 이야기 완성! 🎉</h3>
            <p id="winner-announcement" class="mb-6 text-xl"></p>
            <div id="final-story-preview" class="mb-6 p-4 bg-stone-50 rounded text-left h-64 overflow-y-auto" style="font-family: 'Nanum Myeongjo', serif;"></div>
            <button id="play-again-button" class="w-full btn btn-lg btn-primary">새로운 이야기 만들기</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const startScreen = document.getElementById('start-screen'),
            startGameBtn = document.getElementById('start-game-button'),
            gameContainer = document.getElementById('game-container'),
            storyArea = document.getElementById('story-area'),
            deckCountEl = document.getElementById('deck-count'),
            playedCardCountEl = document.getElementById('played-card-count'),
            allPlayerInfoContainer = document.getElementById('all-player-info-container'),
            endingCardEl = document.getElementById('ending-card'),
            storyModal = document.getElementById('story-modal'),
            selectedCardInfo = document.getElementById('selected-card-info'),
            storyInput = document.getElementById('story-input'),
            cancelStoryButton = document.getElementById('cancel-story-button'),
            submitStoryButton = document.getElementById('submit-story-button'),
            validationModal = document.getElementById('validation-modal'),
            validationTitle = document.getElementById('validation-title'),
            proposerAnnouncement = document.getElementById('proposer-announcement'),
            validationStoryPreview = document.getElementById('validation-story-preview'),
            rejectButton = document.getElementById('reject-button'),
            acceptButton = document.getElementById('accept-button'),
            winModal = document.getElementById('win-modal'),
            winnerAnnouncement = document.getElementById('winner-announcement'),
            finalStoryPreview = document.getElementById('final-story-preview'),
            playAgainButton = document.getElementById('play-again-button');

        // Card Data
        const STORY_CARDS = [ { name: "왕자", type: "인물", icon: "🤴" }, { name: "공주", type: "인물", icon: "👸" }, { name: "마녀", type: "인물", icon: "🧙‍♀️" }, { name: "용", type: "인물", icon: "🐉" }, { name: "기사", type: "인물", icon: "🛡️" }, { name: "요정", type: "인물", icon: "🧚‍♀️" }, { name: "왕", type: "인물", icon: "👑" }, { name: "여왕", type: "인물", icon: "👸" }, { name: "동물 조력자", type: "인물", icon: "🐕" }, { name: "거인", type: "인물", icon: "👹" }, { name: "난쟁이", type: "인물", icon: "👨‍🌾" }, { name: "마법사", type: "인물", icon: "🧙‍♂️" }, { name: "사냥꾼", type: "인물", icon: "🏹" }, { name: "현자", type: "인물", icon: "👴" }, { name: "괴물", type: "인물", icon: "👾" }, { name: "유령", type: "인물", icon: "👻" }, { name: "해적", type: "인물", icon: "🏴‍☠️" }, { name: "음유시인", type: "인물", icon: "🎶" }, { name: "도둑", type: "인물", icon: "🏃" }, { name: "공주", type: "인물", icon: "👸" }, { name: "숲", type: "장소", icon: "🌲" }, { name: "성", type: "장소", icon: "🏰" }, { name: "동굴", type: "장소", icon: "🦇" }, { name: "마을", type: "장소", icon: "🏘️" }, { name: "탑", type: "장소", icon: "🗼" }, { name: "강", type: "장소", icon: "🏞️" }, { name: "시장", type: "장소", icon: "🛒" }, { name: "다리", type: "장소", icon: "🌉" }, { name: "바다", type: "장소", icon: "🌊" }, { name: "사막", type: "장소", icon: "🏜️" }, { name: "폐허", type: "장소", icon: "🏚️" }, { name: "미궁", type: "장소", icon: "🌀" }, { name: "폭포", type: "장소", icon: "🌊" }, { name: "산", type: "장소", icon: "⛰️" }, { name: "섬", type: "장소", icon: "🏝️" }, { name: "마법 지팡이", type: "사물", icon: "🪄" }, { name: "검", type: "사물", icon: "⚔️" }, { name: "지도", type: "사물", icon: "🗺️" }, { name: "보물", type: "사물", icon: "💎" }, { name: "열쇠", type: "사물", icon: "🔑" }, { name: "물약", type: "사물", icon: "🧪" }, { name: "반지", type: "사물", icon: "💍" }, { name: "거울", type: "사물", icon: "🪞" }, { name: "망토", type: "사물", icon: "🧥" }, { name: "왕관", type: "사물", icon: "👑" }, { name: "독약", type: "사물", icon: "☠️" }, { name: "주문서", type: "사물", icon: "📜" }, { name: "나침반", type: "사물", icon: "🧭" }, { name: "가면", type: "사물", icon: "🎭" }, { name: "보석", type: "사물", icon: "💍" }, { name: "배", type: "사물", icon: "⛵" }, { name: "상자", type: "사물", icon: "📦" }, { name: "램프", type: "사물", icon: "💡" }, { name: "책", type: "사물", icon: "📖" }, { name: "활", type: "사물", icon: "🏹" }, { name: "행복하게", type: "상태", icon: "😊" }, { name: "슬프게", type: "상태", icon: "😢" }, { name: "용감하게", type: "상태", icon: "💪" }, { name: "신비롭게", type: "상태", icon: "✨" }, { name: "비밀스럽게", type: "상태", icon: "🤫" }, { name: "영원히", type: "상태", icon: "♾️" }, { name: "운명처럼", type: "상태", icon: "💫" }, { name: "저주받은", type: "상태", icon: "💀" }, { name: "축복받은", type: "상태", icon: "🌟" }, { name: "숨겨진", type: "상태", icon: "🚪" }, { name: "배고픈", type: "상태", icon: "😋" }, { name: "아름다운", type: "상태", icon: "😍" }, { name: "무서운", type: "상태", icon: "😱" }, { name: "부유한", type: "상태", icon: "💰" }, { name: "가난한", type: "상태", icon: "😟" }, { name: "갑자기", type: "사건", icon: "⚡️" }, { name: "오래 전", type: "사건", icon: "📜" }, { name: "위험에 빠졌다", type: "사건", icon: "🔥" }, { name: "여행을 떠났다", type: "사건", icon: "🚶‍♂️" }, { name: "잠이 들었다", type: "사건", icon: "😴" }, { name: "함정에 빠졌다", type: "사건", icon: "🕳️" }, { name: "변신했다", type: "사건", icon: "🦋" }, { name: "싸웠다", type: "사건", icon: "💥" }, { name: "도망쳤다", type: "사건", icon: "💨" }, { name: "축제가 열렸다", type: "사건", icon: "🎉" }, { name: "결혼했다", type: "사건", icon: "💒" }, { name: "길을 잃었다", type: "사건", icon: "❓" }, { name: "만났다", type: "사건", icon: "🤝" }, { name: "헤어졌다", type: "사건", icon: "💔" }, { name: "발견했다", type: "사건", icon: "💡" } ];
        const ENDING_CARDS = [ "그리고 모두는 행복하게 살았답니다.", "그리하여 왕국에는 평화가 찾아왔습니다.", "하지만 놀랍게도, 그 모든 것은 꿈이었습니다.", "그 용감한 행동은 전설로 남아 영원히 기억되었습니다.", "그리고 마법은 풀렸지만, 더 소중한 것을 얻었습니다.", "그 후로 아무도 그들의 소식을 들을 수 없었습니다.", "마침내 오랫동안 찾아 헤매던 것을 발견했습니다.", "그러나 그들의 모험은 이제 막 시작일 뿐이었습니다.", "모든 비밀이 밝혀지고 새로운 시대가 열렸습니다.", "그리하여 예언은 마침내 실현되었습니다.", "결국, 그들은 원래 있던 곳으로 돌아갔습니다." ];

        let gameState = {};

        function initGameState() {
            const storyDeck = shuffle([...STORY_CARDS]);
            const endingDeck = shuffle([...ENDING_CARDS]);
            
            const players = [];
            for (let i = 1; i <= 6; i++) {
                players.push({
                    name: `${i}모둠`,
                    hand: storyDeck.splice(0, 5)
                });
            }

            gameState = {
                players: players,
                storyDeck: storyDeck,
                sharedEndingCard: endingDeck.pop(),
                playedCards: [],
                story: [{ type: 'start', text: '옛날 옛적에...' }],
                currentPlayerIndex: 0,
                activeCard: null,
                activeText: '',
                status: 'playing',
                validationType: null,
            };
        }

        function startGame() {
            startScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            initGameState();
            render();
        }

        function renderStory(storyArray, container) {
            container.innerHTML = storyArray.map(entry => {
                if (entry.type === 'start') {
                    return `<p class="text-center font-bold">${entry.text}</p>`;
                }
                if (entry.type === 'entry') {
                    return `
                        <div class="flex items-start gap-4">
                            ${createCardElement(entry.card, true, -1, 'story-entry-card').outerHTML}
                            <div>
                                <p class="font-bold text-base text-stone-500">${entry.player}님의 이야기</p>
                                <p>${entry.text}</p>
                            </div>
                        </div>
                    `;
                }
                 if (entry.type === 'ending') {
                    return `
                        <div class="p-4 text-center bg-amber-100/50 rounded-lg border-2 border-amber-300">
                            <p class="font-bold text-base text-stone-500">${entry.player}님이 이야기를 마무리했습니다.</p>
                            <p class="text-2xl font-bold text-amber-700">${entry.text}</p>
                        </div>
                    `;
                }
                return '';
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function render() {
            renderStory(gameState.story, storyArea);

            deckCountEl.textContent = gameState.storyDeck.length;
            playedCardCountEl.textContent = gameState.playedCards.length;
            endingCardEl.textContent = gameState.sharedEndingCard;

            allPlayerInfoContainer.innerHTML = '';
            gameState.players.forEach((player, index) => {
                const isCurrentPlayer = index === gameState.currentPlayerIndex;
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-info p-3 my-2 rounded-lg border-2 border-stone-300 transition-all ${isCurrentPlayer ? 'active' : ''}`;

                let cardsHtml = player.hand.map((card, cardIndex) => {
                    if (isCurrentPlayer) {
                        return `<span class="card-name-clickable p-1 rounded" data-card-index="${cardIndex}">${card.name}</span>`;
                    } else {
                        return `<span class="card-name-disabled p-1">${card.name}</span>`;
                    }
                }).join(', ');

                let buttonsHtml = '';
                if (isCurrentPlayer) {
                    buttonsHtml = `
                        <div class="flex gap-2 mt-3">
                            <button class="play-ending-button w-1/2 btn btn-primary text-xs">결말 내기</button>
                            <button class="end-turn-button w-1/2 btn btn-secondary text-xs">차례 끝내기</button>
                        </div>
                    `;
                }

                playerDiv.innerHTML = `
                    <h4 class="font-bold text-lg text-center ${isCurrentPlayer ? 'text-amber-700' : ''}">${player.name} (${player.hand.length}장) ${isCurrentPlayer ? '→' : ''}</h4>
                    <div class="text-base text-stone-600 mt-2 text-center leading-relaxed">${cardsHtml || '카드가 없습니다.'}</div>
                    ${buttonsHtml}
                `;
                allPlayerInfoContainer.appendChild(playerDiv);
            });

            if (gameState.status === 'playing') {
                document.querySelectorAll('.card-name-clickable').forEach(el => {
                    el.addEventListener('click', onCardNameClick);
                });
                const endTurnBtn = document.querySelector('.end-turn-button');
                if (endTurnBtn) endTurnBtn.addEventListener('click', endTurn);
                const playEndingBtn = document.querySelector('.play-ending-button');
                if (playEndingBtn) playEndingBtn.addEventListener('click', onPlayEndingCardClick);
            }
        }

        function onCardNameClick(event) {
            const cardIndex = event.currentTarget.dataset.cardIndex;
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            gameState.activeCard = { ...currentPlayer.hand[cardIndex], index: cardIndex };
            
            selectedCardInfo.innerHTML = createCardElement(gameState.activeCard, false, -1, 'mx-auto').outerHTML;
            storyInput.value = '';
            storyInput.placeholder = `예: ${gameState.activeCard.name}이/가 등장하여...`;
            storyModal.classList.remove('hidden');
            storyInput.focus();
        }

        function submitStory() {
            const text = storyInput.value.trim();
            if (text === '' || !gameState.activeCard) return;

            gameState.activeText = text;
            storyModal.classList.add('hidden');
            
            gameState.status = 'validating';
            gameState.validationType = 'story';

            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            validationTitle.textContent = "이야기 심사";
            proposerAnnouncement.textContent = `${currentPlayer.name}님이 다음 이야기 카드를 내려 합니다:`;
            
            const tempStory = [...gameState.story, { type: 'entry', player: currentPlayer.name, text: gameState.activeText, card: gameState.activeCard }];
            renderStory(tempStory, validationStoryPreview);
            
            validationModal.classList.remove('hidden');
        }

        function endTurn() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            if (gameState.storyDeck.length > 0) {
                currentPlayer.hand.push(gameState.storyDeck.pop());
            }
            gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            render();
        }

        function onPlayEndingCardClick() {
            gameState.status = 'validating';
            gameState.validationType = 'ending';

            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            validationTitle.textContent = "결말 심사";
            proposerAnnouncement.textContent = `${currentPlayer.name}님이 다음 결말로 이야기를 끝내려고 합니다:`;
            
            const finalStory = [...gameState.story, { type: 'ending', player: currentPlayer.name, text: gameState.sharedEndingCard }];
            renderStory(finalStory, validationStoryPreview);
            
            validationModal.classList.remove('hidden');
        }

        function handleAccept() {
            validationModal.classList.add('hidden');
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];

            if (gameState.validationType === 'story') {
                gameState.story.push({ type: 'entry', player: currentPlayer.name, text: gameState.activeText, card: gameState.activeCard });
                const playedCard = currentPlayer.hand.splice(gameState.activeCard.index, 1)[0];
                gameState.playedCards.push(playedCard);
                
                gameState.activeCard = null;
                gameState.activeText = '';
                gameState.status = 'playing';
                render();
            } else if (gameState.validationType === 'ending') {
                gameState.story.push({ type: 'ending', player: currentPlayer.name, text: gameState.sharedEndingCard });
                gameState.status = 'finished';
                winnerAnnouncement.textContent = `${currentPlayer.name}님이 멋진 이야기를 완성했습니다!`;
                renderStory(gameState.story, finalStoryPreview);
                winModal.classList.remove('hidden');
            }
        }

        function handleReject() {
            validationModal.classList.add('hidden');
            
            if (gameState.validationType === 'story') {
                alert('이야기가 기각되었습니다. 카드는 손으로 돌아가고 차례가 넘어갑니다.');
                gameState.activeCard = null;
                gameState.activeText = '';
                endTurn();
            } else if (gameState.validationType === 'ending') {
                alert('결말이 기각되었습니다. 차례가 넘어갑니다.');
                gameState.status = 'playing';
                endTurn();
            }
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function createCardElement(card, isDisabled, cardIndex, extraClasses = '') {
            const el = document.createElement('div');
            el.className = `card w-24 h-36 p-2 flex flex-col justify-between items-center ${isDisabled ? 'disabled' : ''} ${extraClasses}`;
            el.dataset.cardIndex = cardIndex;
            el.innerHTML = `
                <div class="text-xs font-bold px-2 py-0.5 bg-stone-200 text-stone-600 rounded-full">${card.type}</div>
                <div class="text-5xl my-1 flex-grow flex items-center">${card.icon}</div>
                <div class="text-center text-sm font-semibold text-stone-800">${card.name}</div>
            `;
            return el;
        }

        // Event Listeners
        startGameBtn.addEventListener('click', startGame);
        submitStoryButton.addEventListener('click', submitStory);
        storyInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitStory();
            }
        });
        cancelStoryButton.addEventListener('click', () => {
            storyModal.classList.add('hidden');
            gameState.activeCard = null;
        });
        acceptButton.addEventListener('click', handleAccept);
        rejectButton.addEventListener('click', handleReject);
        playAgainButton.addEventListener('click', () => {
            winModal.classList.add('hidden');
            gameContainer.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
    </script>
</body>
</html>
